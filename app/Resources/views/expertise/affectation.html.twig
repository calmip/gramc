{% extends 'default/base.html.twig' %}
{% import "default/macros.html.twig" as gramcmacros %}

{% block myjavascripts %}
 <script   src="{{ asset('js/projets_experts.js') }}" ></script>
{% endblock myjavascripts %}

{% block body %}

<section>

{% if( projets_test == false ) %}
<h1>Affectation des experts aux projets de la session {{ session }}</h1>

{{ form_start( sessionForm ) }}
{{ form_widget( sessionForm.session ) }}
{{ form_widget( sessionForm.submit ) }}
{{ form_end( sessionForm ) }}

{% else %}
<h1>Affectation des experts aux projets test de l'année {{ annee }}</h1>
{% endif %}

<br>

<div id="bilan_legende">
    <div id="bilan">
        <table>
            <tbody>
                <tr>
                    <th colspan="3">Projets</th>
                </tr>
                <tr>
                    <th>Nombre de projets</th>
                    <td>{{ nbProjets }}</td>
                    <td>&nbsp;</td>
                </tr>
                <tr>
                    <th>Nouveaux projets</th>
                    <td>{{  nouveau }}</td>
                    <td><input type="checkbox" class="cb" id="nouveau" checked="checked"></td>
                </tr>
                <tr>
                    <th>Renouvellements</th>
                    <td>{{  renouvellement }}</td>
                    <td><input type="checkbox" class="cb" id="renouv" checked="checked"></td>
                </tr>
                <tr>
                    <th>Heures demandées</th>
                    <td>{{ nbDemHeures}}</td>
                    <td>&nbsp;</td>
                </tr>
                <tr>
                    <th>Heures attribuées</th>
                    <td>{{ nbAttHeures}}</td>
                    <td>&nbsp;</td>
                </tr>
            </tbody>
        </table>

{# #################################################################### #}

        <table id="themas">
            <tbody>
                <tr>
                    <th colspan="3">Thématiques</th>
                </tr>
                {% for key, thema in thematiques %}
                    {% if( thema.projets > 0 ) %}
                    <tr>
                        <th>{{ thema.thematique}}
                            {% if(  thema.experts| length > 0 )%}<br>
                                <small class="light"><em> - {% for expert in thema.experts %}{{expert}} - {% endfor %}</em></small>
                            {% endif %}
                        </th>
                        <td>{{ thema.projets }}</td>
                        <td><input type="checkbox" class="cb" id="t{{ key }}" checked="checked"></td>
                    </tr>
                    {% endif %}
                {% endfor %}
                <tr>
                    <th>Tout décocher</th>
                    <td>&nbsp;</td>
                    <td><input type="checkbox" id="tX" checked="checked"></td>
                </tr>
           </tbody>
        </table>

{# #################################################################### #}
{% if( projets_test == false ) %}

        <table id="experts">
            <tbody>
                <tr>
                    <th colspan="3">Experts</th>
                </tr>
                {% for key, exp in experts %}
                <tr>
                    <th>{{ exp.expert}}
                        {% if( exp.expert.thematique | length > 0 )%}<br>
                        <small class="light"><em> - {% for thematique in exp.expert.thematique %}{{thematique}} - {% endfor %}</em></small>
                        {% endif %}
                    </th>
                    <td>{{ exp.projets }}</td>
                    <td><input type="checkbox" class="cb" id="e{{ key }}" checked="checked"></td>
                </tr>
                {% endfor %}
                <tr>
                    <th>Tout décocher</th>
                    <td>&nbsp;</td>
                    <td><input type="checkbox" id="eX" checked="checked"></td>
                </tr>
            </tbody>
        </table>
{% endif %}
<br /><br />
</section>

{# #################################################################### #}

<section>
    <form name="affecter_les_experts" method="post">
    <div id="projets">
        <table id="affecte_experts">
            <thead>
                <tr>
					<th title="Cocher la case pour sélectionner ce projet">S</th>
                    <th >N</th>
                    <th >N°</th>
                    <th >&nbsp;</th>
                    <th title="Etat">E</th>
                    <th >Titre</th>
                    <th >Thématique</th>
                    <th >Responsable</th>
                    <th >Laboratoire</th>
                    <th title="Affecté">A</th>
                    <th >Expert</th>
                    <th >Demande</th>
                    <th >Attribution</th>
                    {% if noconso==false %}<th >Conso</th>{% endif %}
                </tr>
            </thead>
            <tbody>
            {% for version in versions %}
            <tr>
				<td >
	                {% if( version.libelleEtat=='EDITION_EXPERTISE' or version.libelleEtat== 'EXPERTISE_TEST') %}
					{{ form_widget( forms[version.getIdVersion()].selection ) }}
					{% else %}
					&nbsp;
					{% endif %}
				</td>
                {% if( version.isNouvelle() ) %}
                    <td class="nouveau w15"><strong>N</strong></td>
                {% else %}
                    <td class="renouv w15">&nbsp;</td>
                {% endif %}

                <td > {{  version.projet }}</td>
                <td >
                    <a href="{{ path('consulter_projet', { 'id' : version.projet.idProjet } ) }}">
                    <img class="bouton_poussoir" src="{{ asset('icones/consulter.png') }}" alt="Consulter">
                    </a>
                </td>
                <td >{{ gramcmacros.metagraph(version.projet.metaEtat) }}</td>
                <td >
                    {{ gramcmacros.afftitre(version.prjtitre) }}
                </td>
                {% if( version.prjThematique != null ) %}
                <td class="t{{ version.prjThematique.idThematique }} w170">{{ version.prjThematique }}</td>
                {% else %}
                <td ></td>
                {% endif %}

                <td >
                {% if( version.responsable != null ) %}
                <a class="sudo" href="{{ path('sudo',  { 'id': version.responsable.id }) }}?" title="Changer d'identité">
                            <img class="bouton_poussoir" src="{{ asset('icones/sudo.png') }}" alt="Changer d'identité" /></a>
                <a href="mailto:{{ version.responsable.mail }}" title="Envoyer un courriel au responsable à l'adresse {{ version.responsable.mail }}">
                            <img src="{{ asset('icones/mail_send.png') }}" alt="Envoyer un mail" /></a>
                {{ version.responsable.prenom }} {{ version.responsable.nom }}
                {% endif %}
                </td>

                <td >{% if( version.labo != null ) %}{{ version.labo.acrolabo }}{% endif %}</td>
                <td >
                    {% if( version.hasExpert ) %}
                     <img src="{{ asset('icones/actif.png') }}" alt="Expert affecté" title="Expert affecté"><span class="invisible">affecté</span>
                    {% endif %}
                </td>

                {% if( not (version.getExpert() == null ) ) %}
                <td class="e{{ version.getExpert().idIndividu }} w170">
                {% else %}
                <td >
                {% endif %}
                {% if( version.libelleEtat=='EDITION_EXPERTISE' or version.libelleEtat== 'EXPERTISE_TEST') %}
                    {# {{ form_start( forms[version.getIdVersion()] ) }} #}
                    {{ form_widget( forms[version.getIdVersion()].expert ) }}
                    {# {{ form_end( forms[version.getIdVersion()] ) }} #}
                {% else %}
                    {% if( version.expert!= null ) %}
                    <a class="sudo" href="{{ path('sudo',  { 'id': version.expert.id }) }}?" title="Changer d'identité">
                        <img class="bouton_poussoir" src="{{ asset('icones/sudo.png') }}" alt="Changer d'identité" /></a>
                        {{ version.getExpert() }}
                    {% endif %}
                {% endif %}
                </td>
                <td >{{ version.demHeures }}</td>
                <td >{% if version.idVersion is defined and attHeures[version.idVersion] is defined %}{{ attHeures[version.idVersion] }}{% endif %}</td>
                {% if noconso==false %}
                <td >{{ version.getConso() }}</td>
                {% endif %}
            </tr>
            {% endfor %}
            </tbody>
        </table>
        <div id="bouton_affecter">
			<h2>Pour la sélection</h2>
			{#{{ form_start( forms['BOUTONS'] ) }}#}
			{{ form_widget( forms['BOUTONS'].sub1 ) }}
			{{ form_widget( forms['BOUTONS'].sub2 ) }}
			{{ form_widget( forms['BOUTONS'].sub3 ) }}
			{{ form_widget( forms['BOUTONS'].sub4 ) }}
			{#{{ form_end( forms['BOUTONS'] ) }}#}
		</div>
    </div>
</form>
</section>

{% endblock %}
